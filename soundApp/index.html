<html>

<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/timepicker@1.13.10/jquery.timepicker.js"></script>
    <link rel="stylesheet" href="css/timePickerCSS.css">
    <link rel="stylesheet" href="css/bootstrap.css">
</head>

<body>
    <audio id='myAudio' src='lets begin.m4a'></audio>
    <div>
        <button class='btn btn-primary' id='soundButton' onclick="playAudio()" type="button">Play Sounds</button>
        <button class='btn btn-primary' id='stopSoundButton' onclick="stopAudio()" type="button">Stop sounds</button>
    </div>

    <div name='soundFadeDiv'>
        <label for="soundFade">Sound fade:</label>
        <select id="fadeDropdown" name="soundFade">
            <option value=null>No fade</option>
            <option value="linear">Linear fade</option>
            <option value="squareRoot">Square root fade</option>
            <option value="sinusoidal">Sinusoidal fade</option>
        </select>
        <label for="fadeDurationInput">Fade Duration (milliseconds):</label>
        <input type="number" id="fadeDurationInput" name="fadeDurationInput" min="0" max="10000">
    </div>


    <div>
        <div class="timePicker">
            <p>
                <label>Stop playing at:</label>
                <input onclick='updateTimePickerDropdown()' onchange='setStopPlayingTime()' id="durationExample"
                    type="time" class="time" />
            </p>
        </div>
        <script>
            $(function () {
                $('#durationExample').timepicker({
                    'minTime': new Date(),
                    'showDuration': true,
                    'step': 10,
                    'timeFormat': 'H:i',
                    'noneOption': [
                        {
                            'label': 'Never Stop',
                            'className': 'neverStop',
                            'value': ''
                        }
                    ]
                });
            });

            function updateTimePickerDropdown() {
                $('#durationExample').timepicker('option', 'minTime', new Date());
            }

            let globalSetTimeout;
            function setStopPlayingTime() {
                clearTimeout(globalSetTimeout);
                console.log('interval cleared');
                const stopPlayingAtTime = $('#durationExample').val();
                console.log('Stop playing at: ' + stopPlayingAtTime);
                if (stopPlayingAtTime == '') {
                    return;
                }
                const hours = parseInt(stopPlayingAtTime.split(':')[0]);
                const minutes = parseInt(stopPlayingAtTime.split(':')[1]);
                const timeNowMillis = new Date().getTime();
                const stopAtMillis = new Date().setHours(hours, minutes);
                const nowTillStopDifference = stopAtMillis - timeNowMillis;
                const nowTillStopDifferencePlusOne = new Date().setHours(hours + 24, minutes) - timeNowMillis;
                const timeDifference = nowTillStopDifference < 0 ? nowTillStopDifferencePlusOne : nowTillStopDifference;
                console.log('timeDifference', timeDifference);
                console.log('the resulting date is', timeDifference);
                const stopInMilliseconds =  timeDifference;
                globalSetTimeout = setTimeout(() => { stopAudio() }, stopInMilliseconds);
                console.log('The recording will stop playing in this many hours: ', stopInMilliseconds/(1000*60*60));

            }
        </script>
    </div>

    <p id='text'></p>
</body>
<script>
    // TODO: Add an option to wait between sound recordings
    // TODO: Add an option to 'Stop playing at' with a datepicker
    // TODO: Add an option to play recordings in parallel
    // TODO: Add an option to upload your own recordings
    // TODO: Add an option to record your own recordings
    // TODO: Consider rebuilding this in a framework such as angular
    // TODO: Consider building a development environment as well as a production one
    // TODO: (maybe in the future) - Make this a Freemium service, add payment system for premium features, advertise service with google ads

</script>

<script src='src/util/sleep.js'></script>
<script src='src/soundModification.js'></script>
<script src='src/core.js'></script>

<html>