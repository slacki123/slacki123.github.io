<html>

<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>

<body>
    <audio id='myAudio' src='lets begin.m4a'></audio>
    <button id='soundButton' onclick="playAudio()" type="button">Play Sounds</button>
    <button id='stopSoundButton' onclick="stopAudio()" type="button">Stop sounds</button>
    <p id='text'></p>
</body>
<script>
    const text = document.getElementById('text');
    const myAudio = document.getElementById('myAudio');
    const myAudioSounds = [
        'Birds.m4a',
        'Birds 2.m4a',
        'Birds one cough and fly.m4a',
        'Birds talk at end.m4a',
        'Birds with airplane.m4a',
        'birds with kitchen sounds.m4a',
        'Birds with neighbours talking.m4a',
        'Birds with weird pigeon noise.m4a'
    ];
    async function playAudio() {
        myAudio.play();
        const source = myAudio.getAttribute('src');
        text.innerHTML = 'Playing: ' + source;
    }

    function stopAudio() {
        myAudio.pause();
        myAudio.currentTime = 0;
        text.innerHTML = 'Audio Ended';
    }

    let audioEnded = false;
    myAudio.onended = function () {
        console.log('audio ended');
        const randomSound = myAudioSounds[Math.floor((Math.random() * myAudioSounds.length))];
        myAudio.setAttribute('src', randomSound);
        myAudio.play();
        console.log('Playing: ', randomSound);
        text.innerHTML = 'Playing: ' + randomSound;

        audioEnded = true; // just so the fade only works after at least one audio ended

    }

    myAudio.onloadeddata = async function () {
        console.log('data loaded');
        console.log('audio ended', audioEnded);
        if (audioEnded === true) {
            const fadeDuration = 400;
            const waitTillFade = myAudio.duration - fadeDuration;
            await sleep(waitTillFade);
            fadeBetweenSounds(myAudio, fadeDuration);
        }

    }

    async function fadeBetweenSounds(element, fadeDuration) {
        let incrementalValue = 0.05;
        let numOfIterations = element.volume / incrementalValue;
        const fixedNumOfIterations = (1 / incrementalValue);
        element.volum = 1;
        console.log('element volume', element.volume);
        console.log('num of iterations: ', numOfIterations);
        /// decrease volume
        console.log('Decreasing volume');
        for (let i = numOfIterations; i > 0; i--) {
            await sleep(fadeDuration / fixedNumOfIterations);
            element.volume = parseFloat(element.volume - incrementalValue).toPrecision(15);
            console.log('volume', element.volume);
        }
        /// increase volume
        console.log('Increasing volume');
        numOfIterations = fixedNumOfIterations - (element.volume / incrementalValue);
        console.log('num of iterations should be 0:', numOfIterations);
        for (let i = 0; i < numOfIterations; i++) {
            await sleep(fadeDuration / fixedNumOfIterations);
            element.volume = parseFloat(element.volume + incrementalValue).toPrecision(15);
            console.log('volume', element.volume);
        }
    }

    async function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }




</script>

<html>